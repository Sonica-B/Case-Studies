# Nginx configuration for model routing based on URL path
# This allows accessing both models through a single endpoint

upstream api_backend {
    server localhost:5000;
}

upstream local_backend {
    server localhost:5003;
}

server {
    listen 8000;
    server_name _;

    # Default route - shows model selector page
    location = / {
        default_type text/html;
        return 200 '
        <html>
        <head>
            <title>Model Gateway</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 50px; }
                .container { max-width: 800px; margin: auto; }
                .model-card {
                    border: 2px solid #ddd;
                    padding: 20px;
                    margin: 20px 0;
                    border-radius: 8px;
                }
                .model-card:hover { border-color: #007bff; }
                h1 { color: #333; }
                a { text-decoration: none; color: inherit; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üöÄ Unified Model Gateway</h1>
                <p>Select a model to use:</p>

                <a href="/api/">
                    <div class="model-card">
                        <h2>üì° API Model</h2>
                        <p>Uses HuggingFace API for CLIP inference</p>
                        <p>‚úÖ Faster | ‚úÖ Less resource intensive | ‚ùå Requires internet</p>
                    </div>
                </a>

                <a href="/local/">
                    <div class="model-card">
                        <h2>üíª Local Model</h2>
                        <p>Runs Wav2Vec2 + CLIP locally</p>
                        <p>‚úÖ Private | ‚úÖ No internet needed | ‚ùå More resources</p>
                    </div>
                </a>

                <div style="margin-top: 40px; padding: 20px; background: #f0f0f0; border-radius: 8px;">
                    <h3>Direct Access URLs:</h3>
                    <ul>
                        <li>API Model: <code>/api/</code></li>
                        <li>Local Model: <code>/local/</code></li>
                    </ul>
                    <p><small>Tip: Bookmark your preferred model URL for direct access</small></p>
                </div>
            </div>
        </body>
        </html>';
    }

    # Route to API model
    location /api/ {
        proxy_pass http://api_backend/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Gradio WebSocket support
        proxy_read_timeout 86400;
    }

    # Route to Local model
    location /local/ {
        proxy_pass http://local_backend/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Gradio WebSocket support
        proxy_read_timeout 86400;
    }

    # Health check endpoint
    location /health {
        default_type application/json;
        return 200 '{"status": "healthy", "api": "/api/", "local": "/local/"}';
    }
}